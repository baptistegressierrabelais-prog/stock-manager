<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion de stock ‚Äì Sunny Island</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1a1f3a 100%); color: #e5e7eb; padding: 20px; min-height: 100vh; }
    .container { max-width: 1200px; margin: 0 auto; }
    header { margin-bottom: 40px; text-align: center; }
    h1 { font-size: 32px; background: linear-gradient(135deg, #60a5fa, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: #1e293b; padding: 40px; border-radius: 12px; border: 1px solid #334155; max-width: 500px; width: 100%; }
    .modal-content h2 { margin-bottom: 20px; color: #60a5fa; }
    .modal-content input { width: 100%; padding: 10px 12px; margin-bottom: 15px; background: #0f172a; border: 1px solid #475569; color: #e5e7eb; border-radius: 6px; font-size: 14px; }
    .modal-content button { width: 100%; padding: 10px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .user-info { position: fixed; top: 20px; right: 20px; background: #1e293b; padding: 15px; border-radius: 8px; border: 1px solid #334155; font-size: 12px; z-index: 100; }
    .tabs { display: flex; gap: 8px; margin-bottom: 30px; border-bottom: 2px solid #334155; flex-wrap: wrap; }
    .tab-btn { padding: 12px 24px; background: transparent; border: none; color: #94a3b8; cursor: pointer; font-weight: 600; font-size: 14px; border-bottom: 3px solid transparent; transition: all 0.3s ease; margin-bottom: -2px; }
    .tab-btn:hover { color: #cbd5e1; }
    .tab-btn.active { color: #60a5fa; border-bottom-color: #60a5fa; }
    .tab-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-section { background: #1e293b; padding: 24px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #334155; }
    .form-group { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .input-group { flex: 1; min-width: 200px; }
    label { display: block; font-size: 12px; margin-bottom: 6px; color: #cbd5e1; text-transform: uppercase; letter-spacing: 0.5px; }
    input, select { width: 100%; padding: 10px 12px; background: #0f172a; border: 1px solid #475569; color: #e5e7eb; border-radius: 6px; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    button { padding: 10px 24px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 14px; }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
    .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); padding: 6px 12px; font-size: 12px; }
    .btn-update { background: linear-gradient(135deg, #10b981, #059669); padding: 4px 10px; font-size: 11px; margin-left: 6px; }
    .categories { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px; }
    .category { background: #1e293b; border-radius: 12px; overflow: hidden; border: 1px solid #334155; }
    .category-header { background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 16px; font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 10px; }
    .category-icon { font-size: 20px; }
    .category-count { margin-left: auto; background: rgba(255, 255, 255, 0.2); padding: 4px 10px; border-radius: 20px; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #334155; }
    th { background: #0f172a; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #94a3b8; }
    .qty-badge { display: inline-block; background: #334155; padding: 4px 10px; border-radius: 20px; font-weight: 600; color: #60a5fa; }
    .empty-message { padding: 24px; text-align: center; color: #64748b; font-size: 14px; }
    .action-cell { text-align: center; }
    .vehicles-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    .vehicle-card { background: #1e293b; border-radius: 12px; overflow: hidden; border: 1px solid #334155; }
    .vehicle-header { display: flex; align-items: stretch; height: 60px; }
    .vehicle-number { font-size: 16px; font-weight: 700; color: white; flex: 0 0 25%; display: flex; align-items: center; justify-content: center; border-right: 1px solid #334155; }
    .vehicle-info { flex: 0 0 35%; display: flex; align-items: center; justify-content: center; border-right: 1px solid #334155; }
    .vehicle-info h3 { font-size: 14px; margin: 0; color: #e5e7eb; }
    .vehicle-plate { background: #fbbf24; color: #000; flex: 0 0 40%; font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: center; }
    .vehicle-actions { display: flex; gap: 8px; padding: 12px 16px; background: #1e293b; }
    .vehicle-actions button { flex: 1; padding: 8px 12px; font-size: 12px; }
    .role-item { background: #0f172a; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #334155; }
    .role-item h3 { margin-bottom: 10px; color: #60a5fa; }
    .permissions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px; }
    .permission-checkbox { display: flex; align-items: center; gap: 8px; }
    .permission-checkbox input { width: auto; }
  </style>
</head>
<body>
  <div id="loginModal" class="modal active">
    <div class="modal-content">
      <h2>Premi√®re connexion</h2>
      <input id="firstName" type="text" placeholder="Pr√©nom">
      <input id="lastName" type="text" placeholder="Nom">
      <input id="jobTitle" type="text" placeholder="M√©tier">
      <button onclick="loginUser()">Connexion</button>
    </div>
  </div>

  <div class="user-info" id="userInfo"></div>

  <div class="container" id="mainApp" style="display: none;">
    <header><h1>üèùÔ∏è Blaine County Sheriff Sunny Island - Gestion</h1></header>
    <div class="tabs" id="tabsContainer"></div>

    <div id="inventory" class="tab-content active">
      <div class="form-section">
        <div class="form-group">
          <div class="input-group"><label>Cat√©gorie</label><select id="category"><option value="Armes">üî´ Armes</option><option value="√âquipement Arme">üéØ √âquipement Arme</option><option value="Munitions">üí£ Munitions</option><option value="√âquipement">üß• √âquipement</option><option value="Divers">üì¶ Divers</option></select></div>
          <div class="input-group"><label>Nom de l'objet</label><input id="item" type="text" placeholder="Ex: AK47, 9mm, etc."></div>
          <div class="input-group" style="flex: 0 1 120px;"><label>Quantit√©</label><input id="qty" type="number" placeholder="0" min="0"></div>
          <button onclick="addItem()">Ajouter / Mettre √† jour</button>
        </div>
      </div>
      <div class="categories" id="categoriesContainer"></div>
    </div>

    <div id="vehicles" class="tab-content">
      <div class="form-section">
        <div class="form-group">
          <div class="input-group" style="flex: 0 1 140px;"><label>Matricule (01-99)</label><input id="vehicleNumber" type="text" placeholder="01" maxlength="2"></div>
          <div class="input-group"><label>Nom du v√©hicule</label><input id="vehicleName" type="text" placeholder="Ex: Dispatch, Patrol, etc."></div>
          <div class="input-group"><label>Plaque d'immatriculation</label><input id="vehiclePlate" type="text" placeholder="Ex: AA-123-BB"></div>
          <button onclick="addVehicle()">Ajouter / Mettre √† jour</button>
        </div>
      </div>
      <div class="vehicles-grid" id="vehiclesContainer"></div>
    </div>

    <div id="orders" class="tab-content">
      <div class="form-section">
        <div class="form-group">
          <div class="input-group"><label>Article √† commander</label><input id="orderItem" type="text" placeholder="Ex: AK47, 9mm, Gilet pare-balles, etc."></div>
          <div class="input-group" style="flex: 0 1 120px;"><label>Quantit√©</label><input id="orderQty" type="number" placeholder="0" min="0"></div>
          <button onclick="addOrder()">Ajouter √† la commande</button>
        </div>
      </div>
      <div class="categories" id="ordersContainer"></div>
    </div>

    <div id="repairs" class="tab-content">
      <div class="form-section">
        <div class="form-group">
          <div class="input-group"><label>Nom de l'arme</label><input id="repairWeapon" type="text" placeholder="Ex: AK47, M9, etc."></div>
          <div class="input-group" style="flex: 0 1 120px;"><label>Quantit√©</label><input id="repairQty" type="number" placeholder="0" min="0"></div>
          <button onclick="addRepair()">Ajouter √† la r√©paration</button>
        </div>
      </div>
      <div class="categories" id="repairsContainer"></div>
    </div>

    <div id="admin" class="tab-content">
      <div class="form-section">
        <h2 style="color: #60a5fa; margin-bottom: 20px;">Gestion des r√¥les</h2>
        <div class="form-group">
          <div class="input-group"><label>Nom du r√¥le</label><input id="roleName" type="text" placeholder="Ex: Responsable Stock"></div>
          <button onclick="createRole()">Cr√©er un r√¥le</button>
        </div>
      </div>
      <div id="rolesContainer"></div>

      <div class="form-section" style="margin-top: 40px;">
        <h2 style="color: #60a5fa; margin-bottom: 20px;">Gestion des utilisateurs</h2>
        <div id="usersContainer"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, where, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = { apiKey: "AIzaSyBWHyADypkFFxslXd_9b2EvJIdFUq62qjY", authDomain: "bcssi-stock.firebaseapp.com", projectId: "bcssi-stock" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stockRef = collection(db, "stock");
    const vehiclesRef = collection(db, "vehicles");
    const repairsRef = collection(db, "repairs");
    const ordersRef = collection(db, "orders");
    const usersRef = collection(db, "users");
    const rolesRef = collection(db, "roles");
    
    const adminEmail = "claude@admin.com";
    window.currentUser = null;
    window.lowStockItems = {};
    const categories = { "Armes": { icon: "üî´" }, "√âquipement Arme": { icon: "üéØ" }, "Munitions": { icon: "üí£" }, "√âquipement": { icon: "üß•" }, "Divers": { icon: "üì¶" } };
    const defaultPermissions = { "inventory": false, "vehicles": false, "orders": false, "repairs": false, "admin": false };

    window.loginUser = async () => {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const jobTitle = document.getElementById('jobTitle').value.trim();
      if (!firstName || !lastName || !jobTitle) return;
      
      const userId = firstName.toLowerCase() + lastName.toLowerCase();
      const userDocRef = doc(usersRef, userId);
      const userDoc = await getDoc(userDocRef);

      let permissions, isAdmin, assignedRole;

      if (userDoc.exists()) {
        const userData = userDoc.data();
        permissions = userData.permissions;
        isAdmin = userData.isAdmin;
        assignedRole = userData.assignedRole || null;
      } else {
        isAdmin = (firstName.toLowerCase() === "claude") || (firstName.toLowerCase() === "larry" && lastName.toLowerCase() === "warner");
        permissions = isAdmin ? { inventory: true, vehicles: true, orders: true, repairs: true, admin: true } : { ...defaultPermissions };
        assignedRole = null;
      }
      
      await setDoc(userDocRef, { firstName, lastName, jobTitle, userId, permissions, isAdmin, assignedRole, createdAt: new Date().toISOString() }, { merge: true });
      
      window.currentUser = { userId, firstName, lastName, jobTitle, permissions, isAdmin, assignedRole };
      document.getElementById('loginModal').classList.remove('active');
      document.getElementById('mainApp').style.display = 'block';
      setupTabs();
      updateUserInfo();
    };

    function setupTabs() {
      const container = document.getElementById('tabsContainer');
      container.innerHTML = '';
      
      if (!window.currentUser.isAdmin && !window.currentUser.assignedRole) {
        const noAccess = document.createElement('div');
        noAccess.style.padding = '20px';
        noAccess.style.textAlign = 'center';
        noAccess.style.color = '#ef4444';
        noAccess.textContent = 'Vous n\'avez pas acc√®s √† l\'application. Veuillez contacter un administrateur.';
        container.appendChild(noAccess);
        return;
      }

      const tabs = [
        { id: 'inventory', label: 'üì¶ Inventaire', permission: 'inventory' },
        { id: 'vehicles', label: 'üöó V√©hicules', permission: 'vehicles' },
        { id: 'orders', label: 'üõí Commandes', permission: 'orders' },
        { id: 'repairs', label: 'üîß R√©parations', permission: 'repairs' },
        { id: 'admin', label: '‚öôÔ∏è Admin', permission: 'admin' }
      ];
      tabs.forEach(tab => {
        const hasPermission = window.currentUser.isAdmin || window.currentUser.permissions[tab.permission];
        if (hasPermission) {
          const btn = document.createElement('button');
          btn.className = 'tab-btn' + (tab.id === 'inventory' ? ' active' : '');
          btn.textContent = tab.label;
          btn.onclick = () => switchTab(tab.id);
          container.appendChild(btn);
        }
      });
    }

    function updateUserInfo() {
      const info = document.getElementById('userInfo');
      info.innerHTML = window.currentUser.firstName + ' ' + window.currentUser.lastName + '<br>' + window.currentUser.jobTitle + (window.currentUser.isAdmin ? '<br><span style="color: #60a5fa;">ADMIN</span>' : '');
    }

    window.switchTab = (tabName) => {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    };

    window.createRole = async () => {
      const roleName = document.getElementById('roleName').value.trim();
      if (!roleName) return;
      await setDoc(doc(rolesRef, roleName.toLowerCase()), { name: roleName, permissions: { ...defaultPermissions }, createdAt: new Date().toISOString() });
      document.getElementById('roleName').value = '';
      loadRoles();
    };

    function loadRoles() {
      onSnapshot(rolesRef, (snapshot) => {
        const container = document.getElementById('rolesContainer');
        container.innerHTML = '';
        snapshot.forEach(docu => {
          const role = docu.data();
          const div = document.createElement('div');
          div.className = 'role-item';
          const h3 = document.createElement('h3');
          h3.textContent = role.name;
          div.appendChild(h3);
          const permsDiv = document.createElement('div');
          permsDiv.className = 'permissions';
          Object.keys(defaultPermissions).forEach(perm => {
            const label = document.createElement('label');
            label.className = 'permission-checkbox';
            const inp = document.createElement('input');
            inp.type = 'checkbox';
            inp.checked = role.permissions[perm];
            inp.onchange = () => updateRolePermission(docu.id, perm, inp.checked);
            label.appendChild(inp);
            const txt = document.createElement('span');
            txt.textContent = perm;
            label.appendChild(txt);
            permsDiv.appendChild(label);
          });
          div.appendChild(permsDiv);
          const delBtn = document.createElement('button');
          delBtn.className = 'btn-danger';
          delBtn.textContent = 'Supprimer r√¥le';
          delBtn.onclick = () => deleteDoc(doc(rolesRef, docu.id));
          div.appendChild(delBtn);
          container.appendChild(div);
        });
      });

      onSnapshot(usersRef, (snapshot) => {
        const container = document.getElementById('usersContainer');
        container.innerHTML = '';
        snapshot.forEach(docu => {
          const user = docu.data();
          const div = document.createElement('div');
          div.className = 'role-item';
          const h3 = document.createElement('h3');
          h3.textContent = user.firstName + ' ' + user.lastName;
          const jobP = document.createElement('p');
          jobP.textContent = user.jobTitle;
          jobP.style.fontSize = '12px';
          jobP.style.color = '#94a3b8';
          jobP.style.marginBottom = '10px';
          div.appendChild(h3);
          div.appendChild(jobP);

          const currentRoleP = document.createElement('p');
          currentRoleP.style.fontSize = '12px';
          currentRoleP.style.color = '#60a5fa';
          currentRoleP.style.marginBottom = '15px';
          currentRoleP.textContent = 'R√¥le actuel: ' + (user.assignedRole ? user.assignedRole : 'Aucun');
          if (user.isAdmin) {
            currentRoleP.textContent = 'R√¥le actuel: ADMIN';
            currentRoleP.style.color = '#f59e0b';
          }
          div.appendChild(currentRoleP);

          const roleDiv = document.createElement('div');
          roleDiv.style.marginBottom = '10px';
          const label = document.createElement('label');
          label.style.display = 'block';
          label.style.marginBottom = '8px';
          label.style.fontSize = '12px';
          label.textContent = 'Attribuer un r√¥le:';
          const select = document.createElement('select');
          select.style.width = '100%';
          select.style.padding = '8px';
          select.style.background = '#0f172a';
          select.style.border = '1px solid #475569';
          select.style.color = '#e5e7eb';
          select.style.borderRadius = '6px';
          select.style.marginBottom = '10px';

          const option0 = document.createElement('option');
          option0.value = 'none';
          option0.textContent = 'Aucun r√¥le';
          select.appendChild(option0);

          onSnapshot(rolesRef, (roleSnapshot) => {
            roleSnapshot.forEach(roleDoc => {
              const option = document.createElement('option');
              option.value = roleDoc.id;
              option.textContent = roleDoc.data().name;
              if (user.assignedRole === roleDoc.id) {
                option.selected = true;
              }
              select.appendChild(option);
            });
          });

          select.onchange = () => {
            if (select.value !== 'none') {
              onSnapshot(doc(rolesRef, select.value), (roleDoc) => {
                if (roleDoc.exists()) {
                  const role = roleDoc.data();
                  setDoc(doc(usersRef, docu.id), { permissions: role.permissions, assignedRole: select.value }, { merge: true });
                }
              });
            } else {
              setDoc(doc(usersRef, docu.id), { permissions: { ...defaultPermissions }, assignedRole: null }, { merge: true });
            }
          };

          roleDiv.appendChild(label);
          roleDiv.appendChild(select);
          div.appendChild(roleDiv);

          const delBtn = document.createElement('button');
          delBtn.className = 'btn-danger';
          delBtn.textContent = 'Supprimer utilisateur';
          delBtn.onclick = () => deleteDoc(doc(usersRef, docu.id));
          div.appendChild(delBtn);
          container.appendChild(div);
        });
      });
    }

    window.updateRolePermission = async (roleId, permission, value) => {
      const role = await getDoc(doc(rolesRef, roleId));
      const permissions = role.data().permissions;
      permissions[permission] = value;
      await setDoc(doc(rolesRef, roleId), { permissions }, { merge: true });
    };

    window.addItem = async () => {
      const cat = document.getElementById('category').value;
      const name = document.getElementById('item').value.trim();
      const qty = Number(document.getElementById('qty').value);
      if (!name || qty < 0) return;
      await setDoc(doc(stockRef, cat + '__' + name), { category: cat, name, qty });
      document.getElementById('item').value = '';
      document.getElementById('qty').value = '';
    };

    window.removeItem = async (docId) => await deleteDoc(doc(stockRef, docId));
    window.updateItem = async (docId, newQty) => {
      const qty = Number(newQty);
      if (qty < 0) return;
      await setDoc(doc(stockRef, docId), { qty }, { merge: true });
    };

    window.addVehicle = async () => {
      const numberStr = document.getElementById('vehicleNumber').value.trim();
      const name = document.getElementById('vehicleName').value.trim();
      const plate = document.getElementById('vehiclePlate').value.trim();
      if (!numberStr || numberStr.length !== 2 || !name || !plate) return;
      const number = parseInt(numberStr, 10);
      if (isNaN(number) || number < 1 || number > 99) return;
      const num = String(number).padStart(2, '0');
      await setDoc(doc(vehiclesRef, 'vehicle_' + num), { number: num, name, plate });
      document.getElementById('vehicleNumber').value = '';
      document.getElementById('vehicleName').value = '';
      document.getElementById('vehiclePlate').value = '';
    };

    window.removeVehicle = async (docId) => await deleteDoc(doc(vehiclesRef, docId));
    window.editVehicle = (number, name, plate) => {
      document.getElementById('vehicleNumber').value = number;
      document.getElementById('vehicleName').value = name;
      document.getElementById('vehiclePlate').value = plate;
    };

    window.addOrder = async () => {
      const item = document.getElementById('orderItem').value.trim();
      const qtyValue = document.getElementById('orderQty').value.trim();
      if (!item || !qtyValue) return;
      const qty = parseInt(qtyValue, 10);
      if (isNaN(qty) || qty <= 0) return;
      await setDoc(doc(ordersRef, 'order_' + item + '_' + Date.now()), { item, qty, createdAt: new Date().toISOString() });
      document.getElementById('orderItem').value = '';
      document.getElementById('orderQty').value = '';
    };

    window.removeOrder = async (docId) => await deleteDoc(doc(ordersRef, docId));
    window.incrementOrder = async (docId, qty) => await setDoc(doc(ordersRef, docId), { qty: qty + 1 }, { merge: true });
    window.decrementOrder = async (docId, qty) => {
      if (qty <= 1) await deleteDoc(doc(ordersRef, docId));
      else await setDoc(doc(ordersRef, docId), { qty: qty - 1 }, { merge: true });
    };

    window.addRepair = async () => {
      const weapon = document.getElementById('repairWeapon').value.trim();
      const qtyValue = document.getElementById('repairQty').value.trim();
      if (!weapon || !qtyValue) return;
      const qty = parseInt(qtyValue, 10);
      if (isNaN(qty) || qty <= 0) return;
      await setDoc(doc(repairsRef, 'repair_' + weapon + '_' + Date.now()), { weapon, qty, createdAt: new Date().toISOString() });
      document.getElementById('repairWeapon').value = '';
      document.getElementById('repairQty').value = '';
    };

    window.removeRepair = async (docId) => await deleteDoc(doc(repairsRef, docId));
    window.completeRepair = async (docId) => await deleteDoc(doc(repairsRef, docId));

    function createBadge(txt) {
      const span = document.createElement('span');
      span.className = 'qty-badge';
      span.textContent = txt;
      return span;
    }

    onSnapshot(stockRef, (snapshot) => {
      const data = {};
      window.lowStockItems = {};
      const thresholds = { "Armes": 5, "√âquipement Arme": 20, "Munitions": 5000, "√âquipement": 5, "Divers": 50 };
      snapshot.forEach(docu => {
        const item = docu.data();
        const cat = item.category || "Divers";
        if (!data[cat]) data[cat] = [];
        data[cat].push({ id: docu.id, ...item });
        const threshold = thresholds[cat] || 0;
        if (item.qty < threshold) {
          if (!window.lowStockItems[cat]) window.lowStockItems[cat] = [];
          window.lowStockItems[cat].push({ id: docu.id, ...item, neededQty: threshold - item.qty });
        }
      });

      const container = document.getElementById('categoriesContainer');
      container.innerHTML = '';
      Object.keys(categories).forEach(cat => {
        const items = (data[cat] || []).sort((a, b) => a.qty - b.qty);
        const div = document.createElement('div');
        div.className = 'category';
        const head = document.createElement('div');
        head.className = 'category-header';
        const icon = document.createElement('span');
        icon.className = 'category-icon';
        icon.textContent = categories[cat].icon;
        const title = document.createElement('span');
        title.textContent = cat;
        const count = document.createElement('span');
        count.className = 'category-count';
        count.textContent = items.length;
        head.appendChild(icon);
        head.appendChild(title);
        head.appendChild(count);
        div.appendChild(head);
        if (items.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'empty-message';
          empty.textContent = 'Aucun objet';
          div.appendChild(empty);
        } else {
          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const tr = document.createElement('tr');
          ['Objet', 'Quantit√©', 'Affichage', 'Action'].forEach(txt => {
            const th = document.createElement('th');
            th.textContent = txt;
            if (txt !== 'Objet') th.style.textAlign = txt === 'Action' ? 'center' : 'right';
            tr.appendChild(th);
          });
          thead.appendChild(tr);
          table.appendChild(thead);
          const tbody = document.createElement('tbody');
          items.forEach(item => {
            const tr = document.createElement('tr');
            const td1 = document.createElement('td');
            td1.textContent = item.name;
            tr.appendChild(td1);
            const td2 = document.createElement('td');
            td2.style.textAlign = 'right';
            const inp = document.createElement('input');
            inp.type = 'number';
            inp.id = 'qty-' + item.id;
            inp.value = item.qty;
            inp.min = 0;
            inp.style.width = '80px';
            inp.style.padding = '6px';
            inp.style.background = '#0f172a';
            inp.style.border = '1px solid #475569';
            inp.style.color = '#e5e7eb';
            inp.style.borderRadius = '4px';
            inp.style.textAlign = 'center';
            td2.appendChild(inp);
            tr.appendChild(td2);
            const td3 = document.createElement('td');
            td3.style.textAlign = 'right';
            td3.appendChild(createBadge(Number(item.qty).toLocaleString('fr-FR')));
            tr.appendChild(td3);
            const td4 = document.createElement('td');
            td4.className = 'action-cell';
            const btn1 = document.createElement('button');
            btn1.className = 'btn-update';
            btn1.textContent = '‚úì';
            btn1.onclick = () => updateItem(item.id, document.getElementById('qty-' + item.id).value);
            const btn2 = document.createElement('button');
            btn2.className = 'btn-danger';
            btn2.textContent = '‚úï';
            btn2.onclick = () => removeItem(item.id);
            td4.appendChild(btn1);
            td4.appendChild(btn2);
            tr.appendChild(td4);
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          div.appendChild(table);
        }
        container.appendChild(div);
      });
    });

    onSnapshot(vehiclesRef, (snapshot) => {
      const container = document.getElementById('vehiclesContainer');
      container.innerHTML = '';
      if (snapshot.empty) {
        const empty = document.createElement('div');
        empty.className = 'empty-message';
        empty.textContent = 'Aucun v√©hicule ajout√©';
        container.appendChild(empty);
        return;
      }
      const vehicles = [];
      snapshot.forEach(docu => vehicles.push({ id: docu.id, ...docu.data() }));
      vehicles.sort((a, b) => parseInt(a.number) - parseInt(b.number));
      vehicles.forEach(vehicle => {
        const card = document.createElement('div');
        card.className = 'vehicle-card';
        const header = document.createElement('div');
        header.className = 'vehicle-header';
        const num = document.createElement('div');
        num.className = 'vehicle-number';
        num.textContent = 'BC ' + vehicle.number;
        const info = document.createElement('div');
        info.className = 'vehicle-info';
        const h3 = document.createElement('h3');
        h3.textContent = vehicle.name;
        info.appendChild(h3);
        const plate = document.createElement('div');
        plate.className = 'vehicle-plate';
        plate.textContent = vehicle.plate;
        header.appendChild(num);
        header.appendChild(info);
        header.appendChild(plate);
        card.appendChild(header);
        const actions = document.createElement('div');
        actions.className = 'vehicle-actions';
        const btn1 = document.createElement('button');
        btn1.textContent = '‚úèÔ∏è Modifier';
        btn1.onclick = () => editVehicle(vehicle.number, vehicle.name, vehicle.plate);
        const btn2 = document.createElement('button');
        btn2.className = 'btn-danger';
        btn2.textContent = '‚úï Supprimer';
        btn2.onclick = () => removeVehicle(vehicle.id);
        actions.appendChild(btn1);
        actions.appendChild(btn2);
        card.appendChild(actions);
        container.appendChild(card);
      });
    });

    onSnapshot(ordersRef, (snapshot) => {
      const container = document.getElementById('ordersContainer');
      container.innerHTML = '';
      if (snapshot.empty && !Object.values(window.lowStockItems).some(arr => arr.length > 0)) {
        const empty = document.createElement('div');
        empty.className = 'empty-message';
        empty.textContent = 'Tous les stocks sont suffisants ‚úì';
        container.appendChild(empty);
        return;
      }
      if (!snapshot.empty) {
        const div = document.createElement('div');
        div.className = 'category';
        const head = document.createElement('div');
        head.className = 'category-header';
        head.style.background = 'linear-gradient(135deg, #ec4899, #db2777)';
        const icon = document.createElement('span');
        icon.className = 'category-icon';
        icon.textContent = 'üìù';
        const title = document.createElement('span');
        title.textContent = 'Commandes manuelles';
        const count = document.createElement('span');
        count.className = 'category-count';
        count.textContent = snapshot.size;
        head.appendChild(icon);
        head.appendChild(title);
        head.appendChild(count);
        div.appendChild(head);
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        ['Article', 'Quantit√©', 'Action'].forEach(txt => {
          const th = document.createElement('th');
          th.textContent = txt;
          if (txt !== 'Article') th.style.textAlign = txt === 'Action' ? 'center' : 'right';
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        const orders = [];
        snapshot.forEach(docu => orders.push({ id: docu.id, ...docu.data() }));
        orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        orders.forEach(order => {
          const tr = document.createElement('tr');
          const td1 = document.createElement('td');
          td1.textContent = order.item;
          tr.appendChild(td1);
          const td2 = document.createElement('td');
          td2.style.textAlign = 'right';
          td2.appendChild(createBadge(Number(order.qty).toLocaleString('fr-FR')));
          const btnDec = document.createElement('button');
          btnDec.className = 'btn-update';
          btnDec.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          btnDec.style.marginRight = '4px';
          btnDec.textContent = '‚àí';
          btnDec.onclick = () => decrementOrder(order.id, order.qty);
          const btnInc = document.createElement('button');
          btnInc.className = 'btn-update';
          btnInc.style.marginLeft = '4px';
          btnInc.textContent = '+';
          btnInc.onclick = () => incrementOrder(order.id, order.qty);
          td2.appendChild(btnDec);
          td2.appendChild(btnInc);
          tr.appendChild(td2);
          const td3 = document.createElement('td');
          td3.className = 'action-cell';
          const btnDel = document.createElement('button');
          btnDel.className = 'btn-danger';
          btnDel.textContent = '‚úï';
          btnDel.onclick = () => removeOrder(order.id);
          td3.appendChild(btnDel);
          tr.appendChild(td3);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        div.appendChild(table);
        container.appendChild(div);
      }
      Object.keys(categories).forEach(cat => {
        const items = window.lowStockItems[cat] || [];
        if (items.length === 0) return;
        const div = document.createElement('div');
        div.className = 'category';
        const head = document.createElement('div');
        head.className = 'category-header';
        const icon = document.createElement('span');
        icon.className = 'category-icon';
        icon.textContent = categories[cat].icon;
        const title = document.createElement('span');
        title.textContent = cat;
        const count = document.createElement('span');
        count.className = 'category-count';
        count.textContent = items.length;
        head.appendChild(icon);
        head.appendChild(title);
        head.appendChild(count);
        div.appendChild(head);
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        ['Objet', 'Stock actuel', '√Ä commander'].forEach(txt => {
          const th = document.createElement('th');
          th.textContent = txt;
          th.style.textAlign = 'center';
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        items.forEach(item => {
          const tr = document.createElement('tr');
          const td1 = document.createElement('td');
          td1.textContent = item.name;
          tr.appendChild(td1);
          const td2 = document.createElement('td');
          td2.style.textAlign = 'center';
          td2.appendChild(createBadge(Number(item.qty).toLocaleString('fr-FR')));
          tr.appendChild(td2);
          const td3 = document.createElement('td');
          td3.style.textAlign = 'center';
          const badge = createBadge('+' + Number(item.neededQty).toLocaleString('fr-FR'));
          badge.style.background = '#dc2626';
          badge.style.color = 'white';
          td3.appendChild(badge);
          const btnDec = document.createElement('button');
          btnDec.className = 'btn-update';
          btnDec.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
          btnDec.style.marginRight = '4px';
          btnDec.textContent = '‚àí';
          btnDec.onclick = () => {
            if (item.neededQty <= 1) return;
            setDoc(doc(stockRef, item.id), { qty: item.qty + item.neededQty - 1 }, { merge: true });
          };
          const btnInc = document.createElement('button');
          btnInc.className = 'btn-update';
          btnInc.style.marginLeft = '4px';
          btnInc.textContent = '+';
          btnInc.onclick = () => setDoc(doc(stockRef, item.id), { qty: item.qty + item.neededQty + 1 }, { merge: true });
          td3.appendChild(btnDec);
          td3.appendChild(btnInc);
          tr.appendChild(td3);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        div.appendChild(table);
        container.appendChild(div);
      });
    });

    onSnapshot(repairsRef, (snapshot) => {
      const container = document.getElementById('repairsContainer');
      container.innerHTML = '';
      if (snapshot.empty) {
        const empty = document.createElement('div');
        empty.className = 'empty-message';
        empty.textContent = 'Aucune arme en r√©paration';
        container.appendChild(empty);
        return;
      }
      const div = document.createElement('div');
      div.className = 'category';
      const head = document.createElement('div');
      head.className = 'category-header';
      const icon = document.createElement('span');
      icon.className = 'category-icon';
      icon.textContent = 'üîß';
      const title = document.createElement('span');
      title.textContent = 'Armes en r√©paration';
      const count = document.createElement('span');
      count.className = 'category-count';
      count.textContent = snapshot.size;
      head.appendChild(icon);
      head.appendChild(title);
      head.appendChild(count);
      div.appendChild(head);
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      ['Arme', 'Quantit√©', 'Action'].forEach(txt => {
        const th = document.createElement('th');
        th.textContent = txt;
        if (txt !== 'Arme') th.style.textAlign = txt === 'Action' ? 'center' : 'right';
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      const repairs = [];
      snapshot.forEach(docu => repairs.push({ id: docu.id, ...docu.data() }));
      repairs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      repairs.forEach(repair => {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td');
        td1.textContent = repair.weapon;
        tr.appendChild(td1);
        const td2 = document.createElement('td');
        td2.style.textAlign = 'right';
        td2.appendChild(createBadge(Number(repair.qty).toLocaleString('fr-FR')));
        tr.appendChild(td2);
        const td3 = document.createElement('td');
        td3.className = 'action-cell';
        const btn1 = document.createElement('button');
        btn1.className = 'btn-update';
        btn1.textContent = '‚úì R√©par√©';
        btn1.onclick = () => completeRepair(repair.id);
        const btn2 = document.createElement('button');
        btn2.className = 'btn-danger';
        btn2.textContent = '‚úï';
        btn2.onclick = () => removeRepair(repair.id);
        td3.appendChild(btn1);
        td3.appendChild(btn2);
        tr.appendChild(td3);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      div.appendChild(table);
      container.appendChild(div);
    });

    loadRoles();

    document.getElementById('item').addEventListener('keypress', (e) => { if (e.key === 'Enter') addItem(); });
    document.getElementById('qty').addEventListener('keypress', (e) => { if (e.key === 'Enter') addItem(); });
    document.getElementById('vehicleNumber').addEventListener('keypress', (e) => { if (e.key === 'Enter') addVehicle(); });
    document.getElementById('vehicleName').addEventListener('keypress', (e) => { if (e.key === 'Enter') addVehicle(); });
    document.getElementById('vehiclePlate').addEventListener('keypress', (e) => { if (e.key === 'Enter') addVehicle(); });
    document.getElementById('orderItem').addEventListener('keypress', (e) => { if (e.key === 'Enter') addOrder(); });
    document.getElementById('orderQty').addEventListener('keypress', (e) => { if (e.key === 'Enter') addOrder(); });
    document.getElementById('repairWeapon').addEventListener('keypress', (e) => { if (e.key === 'Enter') addRepair(); });
    document.getElementById('repairQty').addEventListener('keypress', (e) => { if (e.key === 'Enter') addRepair(); });

    window.getDoc = async (docRef) => {
      const snap = await getDoc(docRef);
      return snap;
    };
  </script>
</body>
</html>
